
# .github/workflows/security-scan.yml
name: "ðŸ”’ Security Scan"

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'terraform/**'
  push:
    branches: [main]
    paths:
      - 'terraform/**'
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM UTC
  workflow_dispatch:

env:
  TF_VERSION: "1.5.7"

jobs:
  security-scan:
    name: "ðŸ”’ Security Analysis"
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: ðŸŽ¯ Terraform Format Check
        run: |
          terraform fmt -check -recursive terraform/
          echo "âœ… Terraform format check passed"

      - name: ðŸš€ Initialize All Environments
        run: |
          for env in dev stage prod; do
            echo "ðŸ”§ Initializing $env environment..."
            cd terraform/environments/$env
            terraform init -backend=false
            cd ../../..
          done

      - name: âœ… Validate All Configurations
        run: |
          for env in dev stage prod; do
            echo "âœ… Validating $env environment..."
            cd terraform/environments/$env
            terraform validate
            cd ../../..
          done

      - name: ðŸ” Run tfsec Security Scan
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: terraform/
          soft_fail: true
          format: sarif
          output: tfsec-results.sarif

      - name: ðŸ“¤ Upload tfsec Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: tfsec-results.sarif
          category: tfsec

      - name: ðŸ›¡ï¸ Run Checkov Security Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: terraform/
          framework: terraform
          soft_fail: true
          output_format: sarif
          output_file_path: checkov-results.sarif

      - name: ðŸ“¤ Upload Checkov Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: checkov-results.sarif
          category: checkov

      - name: ðŸ” Run Terrascan
        uses: tenable/terrascan-action@main
        with:
          iac_type: 'terraform'
          iac_dir: 'terraform/'
          policy_type: 'aws'
          only_warn: true
          sarif_upload: true

      - name: ðŸŽ¯ Custom Security Checks
        run: |
          echo "ðŸ” Running custom security checks..."
          
          # Check for hardcoded secrets
          echo "Checking for potential secrets..."
          if grep -r -i "password\|secret\|key" terraform/ --include="*.tf" --include="*.tfvars" | grep -v "variable\|description\|type"; then
            echo "âš ï¸ Potential hardcoded secrets found"
          else
            echo "âœ… No hardcoded secrets detected"
          fi
          
          # Check for overly permissive security groups
          echo "Checking for overly permissive security groups..."
          if grep -r "0.0.0.0/0" terraform/ --include="*.tf" | grep -v "egress"; then
            echo "âš ï¸ Overly permissive ingress rules found"
          else
            echo "âœ… No overly permissive ingress rules detected"
          fi
          
          # Check for public subnets
          echo "Checking subnet configurations..."
          if grep -r "map_public_ip_on_launch.*true" terraform/ --include="*.tf"; then
            echo "â„¹ï¸ Public subnets detected (expected for ALB)"
          fi

      - name: ðŸ“Š Generate Security Report
        run: |
          echo "# ðŸ”’ Security Scan Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **tfsec**: Completed (check Security tab for details)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Checkov**: Completed (check Security tab for details)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Terrascan**: Completed (check Security tab for details)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Custom Checks**: Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Environment Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”§ **Development**: Scanned" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”§ **Staging**: Scanned" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”§ **Production**: Scanned" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Note**: Detailed findings are available in the Security tab above." >> $GITHUB_STEP_SUMMARY

