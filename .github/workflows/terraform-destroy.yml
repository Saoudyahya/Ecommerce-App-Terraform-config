  name: "💥 Terraform Destroy"

  on:
    workflow_dispatch:
      inputs:
        environment:
          description: 'Environment to destroy'
          required: true
          type: choice
          options:
            - dev
            - stage
        confirmation:
          description: 'Type "destroy" to confirm'
          required: true
          type: string

  env:
    TF_VERSION: "1.5.7"
    AWS_REGION: "us-west-2"

  jobs:
    validate-input:
      name: "🔍 Validate Destruction Request"
      runs-on: ubuntu-latest
      outputs:
        proceed: ${{ steps.validate.outputs.proceed }}

      steps:
        - name: ✅ Validate Confirmation
          id: validate
          run: |
            if [ "${{ github.event.inputs.confirmation }}" = "destroy" ]; then
              echo "proceed=true" >> $GITHUB_OUTPUT
              echo "✅ Confirmation validated"
            else
              echo "proceed=false" >> $GITHUB_OUTPUT
              echo "❌ Invalid confirmation. Must type 'destroy'"
              exit 1
            fi

        - name: 🚫 Block Production
          if: github.event.inputs.environment == 'prod'
          run: |
            echo "🚫 Production destruction is not allowed via GitHub Actions"
            echo "Use manual process for production destruction"
            exit 1

    destroy:
      name: "💥 Destroy ${{ github.event.inputs.environment }}"
      runs-on: ubuntu-latest
      needs: validate-input
      if: needs.validate-input.outputs.proceed == 'true'

      environment:
        name: ${{ github.event.inputs.environment }}-destroy

      permissions:
        contents: read
        id-token: write

      steps:
        - name: 📥 Checkout Repository
          uses: actions/checkout@v4

        - name: 🔧 Configure AWS Credentials
          uses: aws-actions/configure-aws-credentials@v4
          with:
            role-to-assume: ${{ secrets[format('AWS_ROLE_ARN_{0}', upper(github.event.inputs.environment))] }}
            role-session-name: terraform-destroy-${{ github.event.inputs.environment }}
            aws-region: ${{ env.AWS_REGION }}

        - name: 🏗️ Setup Terraform
          uses: hashicorp/setup-terraform@v3
          with:
            terraform_version: ${{ env.TF_VERSION }}

        - name: 🚀 Terraform Initialize
          working-directory: terraform/environments/${{ github.event.inputs.environment }}
          run: |
            terraform init -input=false
            echo "✅ Terraform initialized"

        - name: 📊 Terraform Destroy Plan
          working-directory: terraform/environments/${{ github.event.inputs.environment }}
          run: |
            terraform plan -destroy \
              -var-file="terraform.tfvars" \
              -out="destroy.plan"
            
            echo "📋 Destroy plan created"

        - name: ⚠️ Final Warning
          run: |
            echo "🚨 FINAL WARNING 🚨"
            echo "About to destroy: ${{ github.event.inputs.environment }}"
            echo "This action is IRREVERSIBLE!"
            echo "All data and resources will be permanently deleted!"

        - name: 💥 Execute Destruction
          working-directory: terraform/environments/${{ github.event.inputs.environment }}
          run: |
            terraform apply destroy.plan
            echo "💥 Infrastructure destroyed for ${{ github.event.inputs.environment }}"

        - name: 🧹 Cleanup
          working-directory: terraform/environments/${{ github.event.inputs.environment }}
          run: |
            # Remove local state files
            rm -f terraform.tfstate*
            rm -f *.plan
            echo "🧹 Local cleanup completed"

        - name: 📊 Destruction Summary
          run: |
            echo "## 💥 Destruction Summary" >> $GITHUB_STEP_SUMMARY
            echo "**Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
            echo "**Status**: Destroyed" >> $GITHUB_STEP_SUMMARY
            echo "**Timestamp**: $(date)" >> $GITHUB_STEP_SUMMARY
            echo "**Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

        - name: 💬 Notify Team
          uses: 8398a7/action-slack@v3
          with:
            status: custom
            custom_payload: |
              {
                text: "💥 Infrastructure Destroyed",
                attachments: [{
                  color: "danger",
                  fields: [{
                    title: "Environment",
                    value: "${{ github.event.inputs.environment }}",
                    short: true
                  }, {
                    title: "Triggered by",
                    value: "${{ github.actor }}",
                    short: true
                  }]
                }]
              }
          env:
            SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
